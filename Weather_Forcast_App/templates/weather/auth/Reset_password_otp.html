{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi - VN Weather Hub</title>
  <link rel="stylesheet" href="{% static 'weather/css/Auth.css' %}?v=2003">
  <style>
    .strength-container {
      margin-top: 12px;
    }
    .strength-bars {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }
    .strength-bar {
      flex: 1;
      height: 4px;
      background: #334155;
      border-radius: 2px;
      transition: background 0.3s ease;
    }
    .requirements {
      font-size: 12px;
      color: #94a3b8;
      line-height: 1.8;
    }
    .requirements div {
      transition: color 0.2s ease;
    }
    .req-pass {
      color: #22c55e !important;
    }
    .req-fail {
      color: #94a3b8;
    }
    .match-indicator {
      font-size: 12px;
      margin-top: 6px;
      display: none;
    }
    .match-ok { color: #22c55e; }
    .match-fail { color: #ef4444; }
  </style>
</head>
<body class="auth-page">
  <div class="auth-bg">
    <div class="auth-particles"></div>
    <div class="auth-gradient"></div>
  </div>

  <div class="auth-container">
    <div class="auth-card glass-effect">
      <div class="auth-header">
        <div class="icon-wrapper-large">
          <div class="icon-circle-gradient">
            <div class="icon-inner">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                <circle cx="12" cy="16" r="1"/>
              </svg>
            </div>
          </div>
        </div>
        <h1 class="auth-title">ƒê·∫∑t m·∫≠t kh·∫©u m·ªõi</h1>
        <p class="auth-subtitle">T·∫°o m·∫≠t kh·∫©u m·∫°nh ƒë·ªÉ b·∫£o v·ªá t√†i kho·∫£n c·ªßa b·∫°n</p>
      </div>

      {% if messages %}
        <div class="auth-messages">
          {% for message in messages %}
            <div class="auth-alert auth-alert-{{ message.tags }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" action="{% url 'weather:reset_password_otp' %}" class="auth-form" id="resetForm">
        {% csrf_token %}
        
        <div class="form-group animated-input">
          <label class="form-label">
            <span class="label-icon">üîí</span>
            M·∫≠t kh·∫©u m·ªõi
          </label>
          <div class="input-wrapper">
            <input type="password" name="new_password" id="new_password" class="form-input" required minlength="8" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
            <span class="input-border"></span>
          </div>
          
          <div class="strength-container" id="strengthContainer" style="display: none;">
            <div class="strength-bars">
              <div class="strength-bar"></div>
              <div class="strength-bar"></div>
              <div class="strength-bar"></div>
              <div class="strength-bar"></div>
            </div>
            <div class="requirements">
              <div id="req-length" class="req-fail">‚ùå T·ªëi thi·ªÉu 8 k√Ω t·ª±</div>
              <div id="req-lower" class="req-fail">‚ùå C√≥ ch·ªØ th∆∞·ªùng (a-z)</div>
              <div id="req-upper" class="req-fail">‚ùå C√≥ ch·ªØ in hoa (A-Z)</div>
              <div id="req-digit" class="req-fail">‚ùå C√≥ ch·ªØ s·ªë (0-9)</div>
              <div id="req-special" class="req-fail">‚ùå C√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát (!@#$%^&*()-_+=)</div>
            </div>
          </div>
        </div>

        <div class="form-group animated-input">
          <label class="form-label">
            <span class="label-icon">üîí</span>
            X√°c nh·∫≠n m·∫≠t kh·∫©u
          </label>
          <div class="input-wrapper">
            <input type="password" name="confirm_password" id="confirm_password" class="form-input" required minlength="8" placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u">
            <span class="input-border"></span>
          </div>
          <div class="match-indicator" id="matchIndicator"></div>
        </div>

        <button class="btn btn-primary btn-full btn-glow" type="submit" id="submitBtn">
          <span class="btn-text">ƒê·ªïi m·∫≠t kh·∫©u</span>
          <span class="btn-icon">‚úì</span>
        </button>
      </form>

      <div class="auth-footer" style="margin-top: 20px;">
        <a href="{% url 'weather:login' %}" class="auth-link">
          ‚Üê Quay l·∫°i ƒëƒÉng nh·∫≠p
        </a>
      </div>
    </div>
  </div>

  <script>
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const strengthContainer = document.getElementById('strengthContainer');
    const strengthBars = document.querySelectorAll('.strength-bar');
    const matchIndicator = document.getElementById('matchIndicator');
    const form = document.getElementById('resetForm');

    newPassword.addEventListener('input', function() {
      const val = newPassword.value;
      strengthContainer.style.display = val.length > 0 ? 'block' : 'none';
      
      const checks = {
        length: val.length >= 8,
        lower: /[a-z]/.test(val),
        upper: /[A-Z]/.test(val),
        digit: /[0-9]/.test(val),
        special: /[!@#$%^&*()\-_+=]/.test(val)
      };
      
      // Update requirement indicators
      updateReq('req-length', checks.length, 'T·ªëi thi·ªÉu 8 k√Ω t·ª±');
      updateReq('req-lower', checks.lower, 'C√≥ ch·ªØ th∆∞·ªùng (a-z)');
      updateReq('req-upper', checks.upper, 'C√≥ ch·ªØ in hoa (A-Z)');
      updateReq('req-digit', checks.digit, 'C√≥ ch·ªØ s·ªë (0-9)');
      updateReq('req-special', checks.special, 'C√≥ k√Ω t·ª± ƒë·∫∑c bi·ªát (!@#$%^&*()-_+=)');
      
      // Count passed checks
      const passed = Object.values(checks).filter(Boolean).length;
      
      // Update strength bars
      const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e'];
      strengthBars.forEach((bar, i) => {
        bar.style.background = i < passed ? colors[Math.min(passed - 1, 3)] : '#334155';
      });

      // Check match
      checkMatch();
    });

    function updateReq(id, passed, text) {
      const el = document.getElementById(id);
      el.innerHTML = (passed ? '‚úÖ ' : '‚ùå ') + text;
      el.className = passed ? 'req-pass' : 'req-fail';
    }

    confirmPassword.addEventListener('input', checkMatch);

    function checkMatch() {
      const val1 = newPassword.value;
      const val2 = confirmPassword.value;
      
      if (val2.length === 0) {
        matchIndicator.style.display = 'none';
        return;
      }
      
      matchIndicator.style.display = 'block';
      if (val1 === val2) {
        matchIndicator.innerHTML = '‚úÖ M·∫≠t kh·∫©u kh·ªõp';
        matchIndicator.className = 'match-indicator match-ok';
      } else {
        matchIndicator.innerHTML = '‚ùå M·∫≠t kh·∫©u kh√¥ng kh·ªõp';
        matchIndicator.className = 'match-indicator match-fail';
      }
    }

    form.addEventListener('submit', function(e) {
      if (newPassword.value !== confirmPassword.value) {
        e.preventDefault();
        alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
        return false;
      }
      
      // Check password strength
      const val = newPassword.value;
      const isStrong = val.length >= 8 && 
                       /[a-z]/.test(val) && 
                       /[A-Z]/.test(val) && 
                       /[0-9]/.test(val) && 
                       /[!@#$%^&*()\-_+=]/.test(val);
      
      if (!isStrong) {
        e.preventDefault();
        alert('M·∫≠t kh·∫©u ch∆∞a ƒë·ªß m·∫°nh. Vui l√≤ng ƒë·∫£m b·∫£o ƒë·ªß c√°c y√™u c·∫ßu.');
        return false;
      }
    });
  </script>
</body>
</html>
