{% load static %}
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>D·ªØ li·ªáu</title>
  <link rel="stylesheet" href="{% static 'weather/css/Home.css' %}">
  <link rel="stylesheet" href="{% static 'weather/css/Datasets.css' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body class="home-page" style="min-height:100vh;">
  <div class="datasets-wrap">
    <div class="datasets-card">

      <div class="datasets-title">
        <div class="title-block">
          <h1 class="page-title">D·ªØ li·ªáu g·∫ßn ƒë√¢y</h1>
          <div class="page-sub">Duy·ªát, xem tr∆∞·ªõc v√† t·∫£i xu·ªëng c√°c t·ªáp ƒë√£ thu th·∫≠p g·∫ßn nh·∫•t.</div>
          <div class="title-underline"></div>
        </div>

        <div class="actions">
          <button type="button" class="pill" id="btnBack">‚Ü© Quay l·∫°i</button>
          <button type="button" class="pill merge" id="btnMerge">üîó G·ªôp d·ªØ li·ªáu</button>
          <a class="pill primary" href="{% url 'weather:home' %}">‚Üê Trang ch·ªß</a>
        </div>
      </div>

      {% if latest %}
        <div class="latest-bar muted">
          M·ªõi nh·∫•t: <b>{{ latest.name }}</b> ‚Ä¢ {{ latest.size_mb }} MB ‚Ä¢ {{ latest.mtime }}
        </div>
      {% else %}
        <div class="latest-bar muted">Kh√¥ng c√≥ t·ªáp n√†o trong th∆∞ m·ª•c output/</div>
      {% endif %}

      <div id="mergeStatus" class="merge-status"></div>

      <table>
        <thead>
          <tr>
            <th>T√™n t·ªáp</th>
            <th>C·∫≠p nh·∫≠t</th>
            <th>Dung l∆∞·ª£ng</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody>
        {% for f in items %}
          <tr>
            <td><code>{{ f.name }}</code></td>
            <td>{{ f.mtime }}</td>
            <td>{{ f.size_mb }} MB</td>
            <td>
              <div class="op-actions">
                <a class="pill small" href="{% url 'weather:dataset_view' f.name %}">üëÄ Xem</a>
                <a class="pill small primary" href="{% url 'weather:dataset_download' f.name %}">‚¨áÔ∏è T·∫£i</a>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu n√†o.</td></tr>
        {% endfor %}
        </tbody>
      </table>

    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const btnBack = document.getElementById("btnBack");
      const btnMerge = document.getElementById("btnMerge");
      const statusEl = document.getElementById("mergeStatus");

      // Back button functionality
      if (btnBack) {
        btnBack.addEventListener("click", function () {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = "{% url 'weather:home' %}";
          }
        });
      }

      // Merge button functionality
      if (btnMerge) {
        btnMerge.addEventListener("click", async function () {
          // Disable button and show processing status
          btnMerge.disabled = true;
          btnMerge.textContent = "‚è≥ ƒêang g·ªôp...";
          
          showStatus("ƒêang x·ª≠ l√Ω g·ªôp d·ªØ li·ªáu...", "processing");

          try {
            const response = await fetch("{% url 'weather:merge_data' %}", {
              method: "POST",
              headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Content-Type": "application/json"
              }
            });

            const data = await response.json();

            if (data.success) {
              showStatus(data.message || "‚úÖ G·ªôp d·ªØ li·ªáu th√†nh c√¥ng!", "success");
              // Reload page after 2 seconds to show updated data
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } else {
              showStatus("‚ùå " + (data.message || "C√≥ l·ªói x·∫£y ra khi g·ªôp d·ªØ li·ªáu"), "error");
              btnMerge.disabled = false;
              btnMerge.textContent = "üîó G·ªôp d·ªØ li·ªáu";
            }
          } catch (error) {
            showStatus("‚ùå L·ªói k·∫øt n·ªëi: " + error.message, "error");
            btnMerge.disabled = false;
            btnMerge.textContent = "üîó G·ªôp d·ªØ li·ªáu";
          }
        });
      }

      function showStatus(message, type) {
        if (!statusEl) return;
        
        statusEl.textContent = message;
        statusEl.className = "merge-status show " + type;
        
        // Auto-hide after 5 seconds for non-processing messages
        if (type !== "processing") {
          setTimeout(() => {
            statusEl.classList.remove("show");
          }, 5000);
        }
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== "") {
          const cookies = document.cookie.split(";");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + "=")) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    });
  </script>
</body>
</html>